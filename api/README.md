# Модуль настройки зарплат (salary_config)

## Описание

Модуль `salary_config` добавляет в CRM-систему гибкую систему настройки зарплат для сотрудников. Позволяет создавать различные конфигурации оплаты для разных ролей и назначать их конкретным пользователям.

## Основные возможности

### 1. Конфигурации зарплат
- **Создание множественных конфигураций** - можно создать разные схемы оплаты
- **Активация/деактивация** - легкое переключение между конфигурациями
- **Копирование конфигураций** - быстрое создание похожих схем оплаты

### 2. Настройки для менеджеров
- Фиксированная зарплата (оклад)
- Бонус за каждый завершенный заказ
- Процент с прибыли от продажи кондиционеров
- Процент с прибыли от дополнительных услуг
- Процент с прибыли от монтажа
- Процент с прибыли от обслуживания
- Процент с прибыли от демонтажа

### 3. Настройки для монтажников
- Фиксированная оплата за каждый монтаж
- Процент с прибыли от дополнительных услуг
- Бонус за качество работы
- Штрафы за жалобы клиентов

### 4. Настройки для владельца
- Доля с каждого завершенного монтажа
- Процент от оставшейся прибыли после выплат сотрудникам

### 5. Корректировки зарплаты
- Премии и штрафы
- Разовые корректировки
- Привязка к периодам
- Ведение истории изменений

## Установка и настройка

### 1. Добавление в INSTALLED_APPS

```python
# settings.py
INSTALLED_APPS = [
    # ... другие приложения
    'salary_config',
]
```

### 2. Добавление в URL-конфигурацию

```python
# urls.py
urlpatterns = [
    # ... другие URL
    path('salary/', include('salary_config.urls')),
]
```

### 3. Выполнение миграций

```bash
python manage.py makemigrations salary_config
python manage.py migrate
```

### 4. Создание конфигурации по умолчанию

```bash
python manage.py create_default_salary_config
```

Или с автоназначением всем пользователям:

```bash
python manage.py create_default_salary_config --assign-all
```

## Использование

### Web-интерфейс

1. **Управление конфигурациями**: `/salary/`
2. **Назначения пользователям**: `/salary/assignments/`
3. **Корректировки зарплат**: `/salary/adjustments/`
4. **Расчет зарплат**: `/salary/calculation/`

### API

#### Конфигурации зарплат
- `GET /api/salary-configs/` - список конфигураций
- `POST /api/salary-configs/` - создание конфигурации
- `PUT /api/salary-configs/{id}/` - обновление конфигурации
- `POST /api/salary-configs/{id}/activate/` - активация конфигурации
- `POST /api/salary-configs/{id}/copy/` - копирование конфигурации

#### Назначения
- `GET /api/salary-assignments/` - список назначений
- `POST /api/salary-assignments/` - создание назначения
- `PUT /api/salary-assignments/{id}/` - обновление назначения

#### Корректировки
- `GET /api/salary-adjustments/` - список корректировок
- `POST /api/salary-adjustments/` - создание корректировки

#### Расчет зарплат
```javascript
// POST /api/salary/calculate/
{
  "user_id": 1,
  "start_date": "2025-06-01",
  "end_date": "2025-06-30"
}
```

### Программный интерфейс

```python
from salary_config.services import SalaryCalculationService, SalaryConfigService

# Расчет зарплаты
result = SalaryCalculationService.calculate_manager_salary(
    manager, start_date, end_date
)

# Создание конфигурации по умолчанию
config = SalaryConfigService.create_default_config()

# Назначение конфигурации пользователю
SalaryConfigService.assign_config_to_user(user, config)
```

## Структура данных

### SalaryConfig
Основная модель конфигурации зарплат:
- `name` - название конфигурации
- `description` - описание
- `is_active` - флаг активности

### ManagerSalaryConfig
Настройки для менеджеров:
- `fixed_salary` - фиксированная зарплата
- `bonus_per_completed_order` - бонус за заказ
- `*_profit_percentage` - проценты с разных категорий

### InstallerSalaryConfig
Настройки для монтажников:
- `payment_per_installation` - оплата за монтаж
- `additional_services_profit_percentage` - процент с доп. услуг
- `quality_bonus` - бонус за качество
- `penalty_per_complaint` - штраф за жалобы

### OwnerSalaryConfig
Настройки для владельца:
- `payment_per_installation` - доля с монтажа
- `remaining_profit_percentage` - процент от остатка

### UserSalaryAssignment
Назначение конфигурации пользователю:
- `user` - пользователь
- `config` - конфигурация зарплаты

### SalaryAdjustment
Корректировки зарплаты:
- `user` - сотрудник
- `adjustment_type` - тип (премия/штраф/корректировка)
- `amount` - сумма
- `reason` - причина
- `period_start/end` - период

## Алгоритм расчета

### Менеджеры
```
Итого = Фиксированная зарплата 
      + (Количество заказов × Бонус за заказ)
      + Σ(Прибыль с категории × Процент для категории)
      + Корректировки
```

### Монтажники
```
Итого = (Количество монтажей × Оплата за монтаж)
      + Σ(Прибыль с доп. услуг × Процент)
      + Корректировки
```

### Владелец
```
Итого = (Количество монтажей × Доля с монтажа)
      + (Оставшаяся прибыль × Процент)
      + Корректировки

Где оставшаяся прибыль = Валовая прибыль - Выплаты сотрудникам
```

## Обратная совместимость

Модуль полностью совместим с существующей системой расчета зарплат. Если конфигурация не назначена пользователю, используется старая логика расчета.

```python
# В finance/utils.py автоматически определяется доступность модуля
try:
    from salary_config.services import SalaryCalculationService
    # Используется новая система
except ImportError:
    # Используется старая система
```

## Администрирование

### Django Admin
Все модели доступны в Django Admin с удобным интерфейсом:
- Цветовая индикация статусов
- Inline-редактирование связанных настроек
- Фильтрация и поиск
- Валидация данных

### Команды управления
```bash
# Создание конфигурации по умолчанию
python manage.py create_default_salary_config

# Принудительное создание новой конфигурации
python manage.py create_default_salary_config --force

# Назначение всем пользователям
python manage.py create_default_salary_config --assign-all
```

## Безопасность

- Доступ только для владельца компании (`role='owner'`)
- Валидация всех входных данных
- Логирование изменений конфигураций
- Отслеживание автора корректировок

## Расширение функциональности

### Добавление новых ролей
Для добавления поддержки новых ролей:

1. Создайте новую модель конфигурации
2. Добавьте логику расчета в `SalaryCalculationService`
3. Обновите формы и сериализаторы

### Добавление новых типов корректировок
Расширьте `ADJUSTMENT_TYPES` в модели `SalaryAdjustment`

### Интеграция с внешними системами
Используйте API для интеграции с внешними системами учета зарплат

## Мониторинг и отчетность

### Статистика
- `GET /api/salary/stats/` - общая статистика по зарплатам
- Количество конфигураций
- Пользователи без назначенных конфигураций
- Недавние корректировки

### Экспорт данных
Планируется добавление экспорта расчетов зарплат в Excel

## Troubleshooting

### Проблема: Пользователи не видят расчеты
**Решение**: Убедитесь, что пользователям назначены конфигурации зарплат

### Проблема: Неправильные расчеты
**Решение**: 
1. Проверьте активность конфигурации
2. Убедитесь в корректности настроек процентов
3. Проверьте корректировки за период

### Проблема: Ошибки при расчете
**Решение**:
1. Проверьте наличие себестоимости у услуг
2. Убедитесь в корректности данных заказов
3. Проверьте логи Django для детальной информации

## Планы развития

1. **Автоматические расчеты** - автоматический расчет зарплат по расписанию
2. **Уведомления** - уведомления о начисленных зарплатах
3. **Шаблоны конфигураций** - предустановленные шаблоны для разных типов компаний
4. **Интеграция с банками** - прямая выплата зарплат через банковские API
5. **Детальная аналитика** - графики и отчеты по зарплатам
6. **Мобильное приложение** - просмотр зарплат сотрудниками