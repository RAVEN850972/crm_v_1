{% extends 'base.html' %}
{% load static %}

{% block title %}Финансы - CRM{% endblock %}
{% block page_name %}Финансы{% endblock %}

{% block content %}
<!-- CSRF Token для JavaScript -->
{% csrf_token %}

<div class="fade-in">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">Финансовый дашборд</h1>
                <p class="page-subtitle">Управление финансами и отчетность</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="refreshFinanceData()">
                    <i class="bi bi-arrow-clockwise me-2"></i>Обновить
                </button>
                <button class="btn btn-primary" onclick="showNewTransactionModal()">
                    <i class="bi bi-plus-circle me-2"></i>Новая транзакция
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-download me-2"></i>Экспорт
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/api/export/finance/" target="_blank">Транзакции (Excel)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportSalaryReport()">Отчет по зарплатам</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Finance Overview Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <i class="bi bi-wallet2"></i>
                </div>
                <h3 class="stats-value" id="companyBalance">{{ company_balance|floatformat:0 }} ₽</h3>
                <p class="stats-label">Баланс компании</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                    <i class="bi bi-arrow-up-circle"></i>
                </div>
                <h3 class="stats-value" id="monthlyIncome">{{ income|floatformat:0 }} ₽</h3>
                <p class="stats-label">Доходы за месяц</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                    <i class="bi bi-arrow-down-circle"></i>
                </div>
                <h3 class="stats-value" id="monthlyExpense">{{ expense|floatformat:0 }} ₽</h3>
                <p class="stats-label">Расходы за месяц</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    <i class="bi bi-graph-up"></i>
                </div>
                {% with profit=income|add:expense|default:0 %}
                <h3 class="stats-value" id="monthlyProfit">
                    {% if profit >= 0 %}
                        {{ profit|floatformat:0 }} ₽
                    {% else %}
                        -{{ profit|add:0|floatformat:0 }} ₽
                    {% endif %}
                </h3>
                {% endwith %}
                <p class="stats-label">Прибыль за месяц</p>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Charts Section -->
        <div class="col-lg-8">
            <!-- Financial Chart -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Динамика доходов и расходов</h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="chartPeriod" onchange="updateChart()">
                                <option value="30">30 дней</option>
                                <option value="90">3 месяца</option>
                                <option value="180">6 месяцев</option>
                                <option value="365">1 год</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="financeChart" height="300"></canvas>
                </div>
            </div>

            <!-- Categories Breakdown -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Расходы по категориям</h5>
                </div>
                <div class="card-body">
                    <canvas id="expenseCategoriesChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Быстрые действия</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="showSalaryCalculationModal()">
                            <i class="bi bi-calculator me-2"></i>Рассчитать зарплаты
                        </button>
                        <button class="btn btn-outline-success" onclick="showIncomeModal()">
                            <i class="bi bi-plus-circle me-2"></i>Добавить доход
                        </button>
                        <button class="btn btn-outline-danger" onclick="showExpenseModal()">
                            <i class="bi bi-dash-circle me-2"></i>Добавить расход
                        </button>
                        <button class="btn btn-outline-info" onclick="showBalanceDetailsModal()">
                            <i class="bi bi-info-circle me-2"></i>Детали баланса
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Последние транзакции</h5>
                        <a href="{% url 'transaction_list' %}" class="btn btn-sm btn-outline-primary">Все</a>
                    </div>
                </div>
                <div class="card-body">
                    <div id="recentTransactions">
                        {% for transaction in transactions %}
                        <div class="transaction-item d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center">
                                <div class="transaction-icon me-3">
                                    {% if transaction.type == 'income' %}
                                        <i class="bi bi-arrow-up-circle text-success"></i>
                                    {% else %}
                                        <i class="bi bi-arrow-down-circle text-danger"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="fw-medium">{{ transaction.description|truncatechars:30 }}</div>
                                    <div class="text-muted small">{{ transaction.created_at|date:"d.m.Y H:i" }}</div>
                                </div>
                            </div>
                            <div class="text-end">
                                {% if transaction.type == 'income' %}
                                    <span class="text-success fw-medium">+{{ transaction.amount|floatformat:0 }} ₽</span>
                                {% else %}
                                    <span class="text-danger fw-medium">-{{ transaction.amount|floatformat:0 }} ₽</span>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-3">
                            <i class="bi bi-inbox display-6 text-muted"></i>
                            <p class="mt-2 text-muted">Нет транзакций</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Tables Section -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Все транзакции</h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="transactionFilter" onchange="filterTransactions()">
                                <option value="">Все типы</option>
                                <option value="income">Доходы</option>
                                <option value="expense">Расходы</option>
                            </select>
                            <input type="date" class="form-control form-control-sm" id="dateFrom" onchange="filterTransactions()">
                            <input type="date" class="form-control form-control-sm" id="dateTo" onchange="filterTransactions()">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Тип</th>
                                    <th>Описание</th>
                                    <th>Связанный заказ</th>
                                    <th>Сумма</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <!-- Данные загружаются через AJAX -->
                            </tbody>
                        </table>
                    </div>
                    <nav id="transactionsPagination" class="mt-3">
                        <!-- Пагинация загружается через AJAX -->
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Transaction Modal -->
<div class="modal fade" id="newTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Новая транзакция</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newTransactionForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="transactionType" class="form-label">Тип транзакции</label>
                        <select class="form-select" id="transactionType" name="type" required>
                            <option value="">Выберите тип</option>
                            <option value="income">Доход</option>
                            <option value="expense">Расход</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transactionAmount" class="form-label">Сумма</label>
                        <input type="number" class="form-control" id="transactionAmount" name="amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="transactionDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="transactionDescription" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="transactionOrder" class="form-label">Связанный заказ (опционально)</label>
                        <select class="form-select" id="transactionOrder" name="order">
                            <option value="">Не связано с заказом</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary" id="saveTransactionBtn">
                        <i class="bi bi-check-lg me-2"></i>Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Salary Calculation Modal -->
<div class="modal fade" id="salaryCalculationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Расчет зарплат</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="salaryCalculationForm" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="salaryPeriodStart" class="form-label">Начало периода</label>
                            <input type="date" class="form-control" id="salaryPeriodStart" required>
                        </div>
                        <div class="col-md-4">
                            <label for="salaryPeriodEnd" class="form-label">Конец периода</label>
                            <input type="date" class="form-control" id="salaryPeriodEnd" required>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-calculator me-2"></i>Рассчитать
                            </button>
                        </div>
                    </div>
                </form>
                <div id="salaryResults">
                    <!-- Результаты расчета зарплат -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Balance Details Modal -->
<div class="modal fade" id="balanceDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Детали баланса</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="balanceDetailsContent">
                <!-- Детали баланса загружаются через AJAX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let financeChart = null;
let expenseCategoriesChart = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadTransactions();
    loadOrdersForSelect();
    
    // Set default date range to current month
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('salaryPeriodStart').value = firstDay.toISOString().split('T')[0];
    document.getElementById('salaryPeriodEnd').value = today.toISOString().split('T')[0];
    
    // Set filter date range to current month
    document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    
    // Form submissions
    document.getElementById('newTransactionForm').addEventListener('submit', handleTransactionSubmit);
    document.getElementById('salaryCalculationForm').addEventListener('submit', handleSalaryCalculation);
});

async function initializeCharts() {
    try {
        // Finance Chart
        const financeCtx = document.getElementById('financeChart').getContext('2d');
        const financeData = await apiRequest('/api/finance/stats/');
        
        financeChart = new Chart(financeCtx, {
            type: 'line',
            data: {
                labels: financeData.daily_stats.map(d => formatDate(d.date)),
                datasets: [
                    {
                        label: 'Доходы',
                        data: financeData.daily_stats.map(d => d.income),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Расходы',
                        data: financeData.daily_stats.map(d => d.expense),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Прибыль',
                        data: financeData.daily_stats.map(d => d.profit),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });

        // Expense Categories Chart
        await loadExpenseCategoriesChart();
        
    } catch (error) {
        console.error('Error initializing charts:', error);
        createEmptyCharts();
    }
}

function createEmptyCharts() {
    const financeCtx = document.getElementById('financeChart').getContext('2d');
    financeChart = new Chart(financeCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
    
    const expenseCtx = document.getElementById('expenseCategoriesChart').getContext('2d');
    expenseCategoriesChart = new Chart(expenseCtx, {
        type: 'doughnut',
        data: {
            labels: ['Нет данных'],
            datasets: [{
                data: [1],
                backgroundColor: ['#e5e7eb']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });
}

async function loadExpenseCategoriesChart() {
    try {
        // Используем существующий API endpoint или создаем мок данные
        let data;
        try {
            data = await apiRequest('/finance/api/expense-categories/');
        } catch (error) {
            // Если endpoint не существует, создаем мок данные
            data = { categories: [] };
        }
        
        const expenseCtx = document.getElementById('expenseCategoriesChart').getContext('2d');
        
        if (expenseCategoriesChart) {
            expenseCategoriesChart.destroy();
        }
        
        if (data.categories && data.categories.length > 0) {
            expenseCategoriesChart = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: data.categories.map(c => c.name),
                    datasets: [{
                        data: data.categories.map(c => c.amount),
                        backgroundColor: [
                            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', 
                            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    return label + ': ' + value;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            expenseCategoriesChart = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Нет расходов'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#e5e7eb']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading expense categories chart:', error);
    }
}

async function loadTransactions(page = 1) {
    try {
        const type = document.getElementById('transactionFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        let url = `/api/transactions/?page=${page}`;
        if (type) url += `&type=${type}`;
        if (dateFrom) url += `&created_at__gte=${dateFrom}`;
        if (dateTo) url += `&created_at__lte=${dateTo}`;
        
        const data = await apiRequest(url);
        
        const tbody = document.getElementById('transactionsTableBody');
        
        if (data.results && data.results.length > 0) {
            tbody.innerHTML = data.results.map(transaction => `
                <tr>
                    <td>${formatDate(transaction.created_at)}</td>
                    <td>
                        <span class="badge bg-${transaction.type === 'income' ? 'success' : 'danger'}">
                            ${transaction.type_display || (transaction.type === 'income' ? 'Доход' : 'Расход')}
                        </span>
                    </td>
                    <td>${transaction.description}</td>
                    <td>${transaction.order_display || 'Не связано'}</td>
                    <td class="text-${transaction.type === 'income' ? 'success' : 'danger'} fw-medium">
                        ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editTransaction(${transaction.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="bi bi-inbox display-6 text-muted"></i>
                        <p class="mt-2 text-muted">Нет транзакций</p>
                    </td>
                </tr>
            `;
        }
        
        if (data.count > 20) {
            updatePagination(data, 'transactionsPagination', loadTransactions);
        }
        
    } catch (error) {
        console.error('Error loading transactions:', error);
        showToast('Ошибка загрузки транзакций', 'danger');
    }
}

async function loadOrdersForSelect() {
    try {
        const data = await apiRequest('/api/orders/');
        
        const select = document.getElementById('transactionOrder');
        select.innerHTML = '<option value="">Не связано с заказом</option>';
        
        if (data.results) {
            data.results.forEach(order => {
                select.innerHTML += `<option value="${order.id}">Заказ #${order.id} - ${order.client_name}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading orders:', error);
    }
}

async function handleTransactionSubmit(e) {
    e.preventDefault();
    
    const btn = document.getElementById('saveTransactionBtn');
    const originalText = showLoading(btn);
    
    try {
        const formData = new FormData(e.target);
        const data = {
            type: formData.get('type'),
            amount: parseFloat(formData.get('amount')),
            description: formData.get('description'),
            order: formData.get('order') || null
        };
        
        const isEdit = e.target.dataset.editId;
        const url = isEdit ? `/api/transactions/${isEdit}/` : '/api/transactions/';
        const method = isEdit ? 'PUT' : 'POST';
        
        await apiRequest(url, {
            method: method,
            body: JSON.stringify(data)
        });
        
        bootstrap.Modal.getInstance(document.getElementById('newTransactionModal')).hide();
        e.target.reset();
        delete e.target.dataset.editId;
        showToast(isEdit ? 'Транзакция обновлена' : 'Транзакция создана', 'success');
        
        await refreshFinanceData();
        await loadTransactions();
        
    } catch (error) {
        console.error('Error saving transaction:', error);
        showToast(error.message || 'Ошибка сохранения транзакции', 'danger');
    } finally {
        hideLoading(btn, originalText);
    }
}

async function handleSalaryCalculation(e) {
    e.preventDefault();
    
    const startDate = document.getElementById('salaryPeriodStart').value;
    const endDate = document.getElementById('salaryPeriodEnd').value;
    
    if (!startDate || !endDate) {
        showToast('Укажите период для расчета', 'warning');
        return;
    }
    
    const resultsDiv = document.getElementById('salaryResults');
    resultsDiv.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2">Расчет зарплат...</p>
        </div>
    `;
    
    try {
        const usersData = await apiRequest('/api/users/');
        const salaryResults = [];
        
        for (const user of usersData.results || []) {
            if (['manager', 'installer', 'owner'].includes(user.role)) {
                try {
                    const salaryData = await apiRequest(`/api/finance/calculate-salary/${user.id}/?start_date=${startDate}&end_date=${endDate}`);
                    salaryResults.push({
                        user: user,
                        salary: salaryData.salary
                    });
                } catch (error) {
                    console.error(`Error calculating salary for user ${user.id}:`, error);
                }
            }
        }
        
        if (salaryResults.length > 0) {
            resultsDiv.innerHTML = `
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Сотрудник</th>
                                <th>Роль</th>
                                <th>Зарплата</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salaryResults.map(result => `
                                <tr>
                                    <td>${result.user.full_name || result.user.username}</td>
                                    <td>${result.user.role_display}</td>
                                    <td class="fw-medium">${formatCurrency(result.salary.total_salary || 0)}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="createSalaryPayment(${result.user.id}, ${result.salary.total_salary || 0}, '${startDate}', '${endDate}')">
                                            Выплатить
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Нет данных для расчета зарплат за указанный период
                </div>
            `;
       }
       
   } catch (error) {
       console.error('Error calculating salaries:', error);
       resultsDiv.innerHTML = `
           <div class="alert alert-danger">
               <i class="bi bi-exclamation-triangle me-2"></i>
               Ошибка расчета зарплат: ${error.message}
           </div>
       `;
   }
}

async function createSalaryPayment(userId, amount, startDate, endDate) {
   try {
       await apiRequest('/api/salary-payments/', {
           method: 'POST',
           body: JSON.stringify({
               user: userId,
               amount: amount,
               period_start: startDate,
               period_end: endDate
           })
       });
       
       showToast('Выплата зарплаты создана', 'success');
       await refreshFinanceData();
       await loadTransactions();
   } catch (error) {
       console.error('Error creating salary payment:', error);
       showToast(error.message || 'Ошибка создания выплаты', 'danger');
   }
}

async function refreshFinanceData() {
   try {
       const data = await apiRequest('/api/finance/balance/');
       
       if (data.balance !== undefined) {
           document.getElementById('companyBalance').textContent = formatCurrency(data.balance);
       }
       
       // Update stats from finance stats API
       const statsData = await apiRequest('/api/finance/stats/');
       if (statsData) {
           document.getElementById('monthlyIncome').textContent = formatCurrency(statsData.income_this_month);
           document.getElementById('monthlyExpense').textContent = formatCurrency(statsData.expense_this_month);
           document.getElementById('monthlyProfit').textContent = formatCurrency(statsData.profit_this_month);
       }
       
       // Update charts
       if (financeChart) {
           financeChart.destroy();
       }
       if (expenseCategoriesChart) {
           expenseCategoriesChart.destroy();
       }
       await initializeCharts();
       
   } catch (error) {
       console.error('Error refreshing finance data:', error);
       showToast('Ошибка обновления данных', 'danger');
   }
}

async function showBalanceDetailsModal() {
   const modal = new bootstrap.Modal(document.getElementById('balanceDetailsModal'));
   const content = document.getElementById('balanceDetailsContent');
   
   content.innerHTML = `
       <div class="text-center py-3">
           <div class="spinner-border" role="status">
               <span class="visually-hidden">Загрузка...</span>
           </div>
       </div>
   `;
   
   modal.show();
   
   try {
       const data = await apiRequest('/api/finance/balance/');
       
       content.innerHTML = `
           <div class="row g-3">
               <div class="col-12">
                   <h6>Текущий баланс: <span class="text-success">${formatCurrency(data.balance || 0)}</span></h6>
               </div>
               <div class="col-12">
                   <h6>Статистика по месяцам:</h6>
                   <div class="table-responsive">
                       <table class="table table-sm">
                           <thead>
                               <tr>
                                   <th>Месяц</th>
                                   <th>Доходы</th>
                                   <th>Расходы</th>
                                   <th>Прибыль</th>
                               </tr>
                           </thead>
                           <tbody>
                               ${(data.monthly_stats || []).map(stat => `
                                   <tr>
                                       <td>${stat.month}</td>
                                       <td class="text-success">${formatCurrency(stat.income)}</td>
                                       <td class="text-danger">${formatCurrency(stat.expense)}</td>
                                       <td class="text-${stat.profit >= 0 ? 'success' : 'danger'}">${formatCurrency(stat.profit)}</td>
                                   </tr>
                               `).join('') || '<tr><td colspan="4" class="text-center">Нет данных</td></tr>'}
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       `;
       
   } catch (error) {
       console.error('Error loading balance details:', error);
       content.innerHTML = `
           <div class="alert alert-danger">
               <i class="bi bi-exclamation-triangle me-2"></i>
               Ошибка загрузки деталей баланса
           </div>
       `;
   }
}

function showNewTransactionModal() {
   bootstrap.Modal.getOrCreateInstance(document.getElementById('newTransactionModal')).show();
}

function showSalaryCalculationModal() {
   bootstrap.Modal.getOrCreateInstance(document.getElementById('salaryCalculationModal')).show();
}

function showIncomeModal() {
   const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('newTransactionModal'));
   document.getElementById('transactionType').value = 'income';
   modal.show();
}

function showExpenseModal() {
   const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('newTransactionModal'));
   document.getElementById('transactionType').value = 'expense';
   modal.show();
}

function filterTransactions() {
   loadTransactions(1);
}

async function updateChart() {
   const period = document.getElementById('chartPeriod').value;
   
   try {
       const data = await apiRequest(`/api/finance/stats/?days=${period}`);
       
       if (financeChart && data.daily_stats) {
           financeChart.data.labels = data.daily_stats.map(d => formatDate(d.date));
           financeChart.data.datasets[0].data = data.daily_stats.map(d => d.income);
           financeChart.data.datasets[1].data = data.daily_stats.map(d => d.expense);
           financeChart.data.datasets[2].data = data.daily_stats.map(d => d.profit);
           
           financeChart.update();
       }
       
   } catch (error) {
       console.error('Error updating chart:', error);
   }
}

function updatePagination(data, containerId, loadFunction) {
   const container = document.getElementById(containerId);
   
   if (!data.count || data.count <= 20) {
       container.innerHTML = '';
       return;
   }
   
   const totalPages = Math.ceil(data.count / 20);
   const currentPage = getCurrentPage(data);
   
   let paginationHtml = '<ul class="pagination pagination-sm justify-content-center">';
   
   if (data.previous) {
       paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); ${loadFunction.name}(${currentPage - 1})">Предыдущая</a></li>`;
   }
   
   for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
       paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
           <a class="page-link" href="#" onclick="event.preventDefault(); ${loadFunction.name}(${i})">${i}</a>
       </li>`;
   }
   
   if (data.next) {
       paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); ${loadFunction.name}(${currentPage + 1})">Следующая</a></li>`;
   }
   
   paginationHtml += '</ul>';
   container.innerHTML = paginationHtml;
}

function getCurrentPage(data) {
   if (data.previous) {
       const url = new URL(data.previous);
       const prevPage = parseInt(url.searchParams.get('page')) || 1;
       return prevPage + 1;
   }
   return 1;
}

async function editTransaction(transactionId) {
   try {
       const transaction = await apiRequest(`/api/transactions/${transactionId}/`);
       
       document.getElementById('transactionType').value = transaction.type;
       document.getElementById('transactionAmount').value = transaction.amount;
       document.getElementById('transactionDescription').value = transaction.description;
       document.getElementById('transactionOrder').value = transaction.order || '';
       
       const form = document.getElementById('newTransactionForm');
       form.dataset.editId = transactionId;
       
       document.querySelector('#newTransactionModal .modal-title').textContent = 'Редактировать транзакцию';
       document.getElementById('saveTransactionBtn').innerHTML = '<i class="bi bi-check-lg me-2"></i>Обновить';
       
       bootstrap.Modal.getOrCreateInstance(document.getElementById('newTransactionModal')).show();
       
   } catch (error) {
       console.error('Error loading transaction for edit:', error);
       showToast('Ошибка загрузки транзакции', 'danger');
   }
}

async function exportSalaryReport() {
   try {
       const startDate = prompt('Начальная дата (YYYY-MM-DD):');
       const endDate = prompt('Конечная дата (YYYY-MM-DD):');
       
       if (!startDate || !endDate) {
           return;
       }
       
       const response = await fetch(`/api/export/salary-report/?start_date=${startDate}&end_date=${endDate}`, {
           headers: {
               'X-CSRFToken': getCsrfToken()
           }
       });
       
       if (response.ok) {
           const blob = await response.blob();
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `salary_report_${startDate}_${endDate}.xlsx`;
           document.body.appendChild(a);
           a.click();
           window.URL.revokeObjectURL(url);
           document.body.removeChild(a);
           
           showToast('Отчет по зарплатам скачан', 'success');
       } else {
           throw new Error('Ошибка экспорта отчета');
       }
       
   } catch (error) {
       console.error('Error exporting salary report:', error);
       showToast('Ошибка экспорта отчета', 'danger');
   }
}

// Helper functions
function formatCurrency(amount) {
   return new Intl.NumberFormat('ru-RU', {
       style: 'currency',
       currency: 'RUB',
       minimumFractionDigits: 0,
       maximumFractionDigits: 0
   }).format(amount || 0);
}

function formatDate(dateString) {
   const date = new Date(dateString);
   return date.toLocaleDateString('ru-RU');
}

function getCsrfToken() {
   return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// API helper from base.html
async function apiRequest(url, options = {}) {
   const defaultOptions = {
       headers: {
           'Content-Type': 'application/json',
           'X-CSRFToken': getCsrfToken()
       }
   };

   const response = await fetch(url, { ...defaultOptions, ...options });
   
   if (!response.ok) {
       const errorData = await response.json().catch(() => ({}));
       throw new Error(errorData.detail || errorData.error || `HTTP error! status: ${response.status}`);
   }
   
   return response.json();
}

// Loading helpers from base.html
function showLoading(button) {
   const originalText = button.innerHTML;
   button.innerHTML = '<span class="loading"></span> Загрузка...';
   button.disabled = true;
   return originalText;
}

function hideLoading(button, originalText) {
   button.innerHTML = originalText;
   button.disabled = false;
}

// Toast helper from base.html
function showToast(message, type = 'success') {
   const toastHtml = `
       <div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
           <div class="d-flex">
               <div class="toast-body">${message}</div>
               <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
           </div>
       </div>
   `;
   
   let toastContainer = document.querySelector('.toast-container');
   if (!toastContainer) {
       toastContainer = document.createElement('div');
       toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
       document.body.appendChild(toastContainer);
   }
   
   toastContainer.insertAdjacentHTML('beforeend', toastHtml);
   const toast = new bootstrap.Toast(toastContainer.lastElementChild);
   toast.show();
}

// Reset form when modal is hidden
document.getElementById('newTransactionModal').addEventListener('hidden.bs.modal', function() {
   const form = document.getElementById('newTransactionForm');
   form.reset();
   delete form.dataset.editId;
   
   document.querySelector('#newTransactionModal .modal-title').textContent = 'Новая транзакция';
   document.getElementById('saveTransactionBtn').innerHTML = '<i class="bi bi-check-lg me-2"></i>Сохранить';
});
</script>

<style>
.transaction-item {
   padding: 0.75rem;
   border-radius: 8px;
   transition: all 0.3s ease;
}

.transaction-item:hover {
   background-color: #f8f9fa;
}

.transaction-icon {
   font-size: 1.25rem;
}

.stats-card {
   background: white;
   border-radius: 12px;
   padding: 1.5rem;
   border: 1px solid var(--border-color);
   transition: all 0.3s ease;
   position: relative;
   overflow: hidden;
}

.stats-card::before {
   content: '';
   position: absolute;
   top: 0;
   left: 0;
   right: 0;
   height: 4px;
   background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
}

.stats-card:hover {
   transform: translateY(-2px);
   box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.stats-icon {
   width: 48px;
   height: 48px;
   border-radius: 10px;
   display: flex;
   align-items: center;
   justify-content: center;
   font-size: 1.25rem;
   color: white;
   margin-bottom: 1rem;
}

.stats-value {
   font-size: 2rem;
   font-weight: 700;
   color: var(--dark-color);
   margin: 0;
}

.stats-label {
   color: #6b7280;
   font-size: 0.875rem;
   margin-top: 0.25rem;
}

.chart-container {
   position: relative;
   height: 300px;
}

.table th {
   background: var(--light-color);
   border-bottom: 2px solid var(--border-color);
   font-weight: 600;
   color: var(--dark-color);
}

.badge {
   font-weight: 500;
   font-size: 0.75rem;
   padding: 0.375rem 0.75rem;
}

.modal-content {
   border-radius: 12px;
   border: none;
   box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.form-control:focus,
.form-select:focus {
   border-color: var(--primary-color);
   box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
}

.btn {
   border-radius: 8px;
   font-weight: 500;
   transition: all 0.3s ease;
}

.btn:hover {
   transform: translateY(-1px);
}

.loading {
   display: inline-block;
   width: 16px;
   height: 16px;
   border: 2px solid rgba(255, 255, 255, 0.3);
   border-radius: 50%;
   border-top-color: #fff;
   animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
   to { transform: rotate(360deg); }
}

@keyframes countUp {
   from { opacity: 0; transform: translateY(20px); }
   to { opacity: 1; transform: translateY(0); }
}

.stats-card {
   animation: countUp 0.5s ease-out;
}

.stats-card:nth-child(2) { animation-delay: 0.1s; }
.stats-card:nth-child(3) { animation-delay: 0.2s; }
.stats-card:nth-child(4) { animation-delay: 0.3s; }

@media (max-width: 768px) {
   .stats-value {
       font-size: 1.5rem;
   }
   
   .page-header .d-flex {
       flex-direction: column;
       align-items: stretch;
   }
   
   .page-header .d-flex > div:last-child {
       margin-top: 1rem;
   }
   
   .table-responsive {
       font-size: 0.875rem;
   }
}
</style>
{% endblock %}